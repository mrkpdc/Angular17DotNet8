<nz-spin [nzSize]="'large'" [nzSpinning]="pageIsLoading">
  <h1 class="text-center">{{'Users' | translate}}</h1>
  <div class="usersContainer">
    <div nz-row>
      <div nz-col nzSpan="20" nzLg="10" nzSm="16">
        <nz-input-group nzSearch nzAddOnBeforeIcon="search" [nzAddOnAfter]="searchButtons">
          <div class="searchBarContainer">
            <input type="text" nz-input [(ngModel)]="usernameFilter" placeholder="{{'Username' | translate}}" />
            <input type="text" nz-input [(ngModel)]="emailFilter" placeholder="{{'Email' | translate}}" />
          </div>
        </nz-input-group>
        <ng-template #searchButtons>
          <button nz-button nzType="primary" nzSearch (click)="getUsers()">{{'Search' | translate}}</button>
          <button nz-button nzType="default" (click)="clearSearchUsers()">{{'Clear' | translate}}</button>
        </ng-template>
      </div>
    </div>
    <div nz-row class="mb-3 mt-5">
      <div nz-col>
        <button nz-button nzType="primary" (click)="showUserFormModal()">{{'AddUser' | translate}}</button>
      </div>
    </div>
    <div *ngFor="let user of users">
      <div nz-row>
        <div nz-col nzSpan="8">
          <div nz-row>
            <div nz-col>
              <h3 class="wordBreakText">
                <i nz-icon nzType="delete" nzTheme="fill" class="iconVerticalAlign pointerCursor redColor"
                   (click)="showDeleteUserModal(user.id)"></i>
                <i nz-icon nzType="edit" nzTheme="fill" class="iconVerticalAlign pointerCursor orangeColor"
                   (click)="showUserFormModal(user)"></i>{{user.userName}}
              </h3>
            </div>
          </div>
          <div nz-row>
            <div nz-col>
              <div nz-row>
                <div nz-col class="wordBreakText">
                  {{'ID' | translate}}: {{user.id}}
                </div>
              </div>
              <div nz-row>
                <div nz-col class="wordBreakText">
                  {{'Username' | translate}}: {{user.userName}}
                </div>
              </div>
              <div nz-row>
                <div nz-col class="wordBreakText">
                  {{'Email' | translate}}: {{user.email}}
                </div>
              </div>
              <!--<div nz-row>
                <div nz-col>
                  <button nz-button nzType="primary" nzDanger (click)="showDeleteUserModal(user.id)">{{'Delete' | translate}}</button>
                </div>
              </div>-->
            </div>
          </div>
        </div>
        <div nz-col nzSpan="8">
          <div nz-row>
            <div nz-col>
              <h4>{{'UserClaims' | translate}}</h4>
            </div>
          </div>
          <div nz-row *ngFor="let claim of user.userClaims">
            <div nz-col class="wordBreakText">
              <i nz-icon nzType="delete" nzTheme="fill" class="iconVerticalAlign pointerCursor redColor"
                 (click)="showRemoveCustomUserClaimModal(user.id, claim.claimType, claim.claimValue)"></i>
              {{claim.claimType}} {{claim.claimValue}}
            </div>
            <!--<div nz-col nzSpan="1" nzMd="8">
              <button nz-button nzType="primary" nzDanger (click)="showRemoveCustomUserClaimModal(user.id, claim.claimType, claim.claimValue)">{{'Delete' | translate}}</button>
            </div>-->
          </div>
          <br />
          <div nz-row>
            <div nz-col>
              <button nz-button nzType="primary" (click)="showAddCustomUserClaimModal(user.id)">{{'CustomClaim' | translate}}</button>
            </div>
            <div nz-col>
              <button nz-button nzType="primary" (click)="showExistingClaimsModal(user.id)">{{'ExistingClaims' | translate}}</button>
            </div>
          </div>
        </div>
        <div nz-col nzSpan="8">
          <div nz-row>
            <div nz-col>
              <h4>{{'UserRoles' | translate}}</h4>
            </div>
          </div>
          <div nz-row *ngFor="let role of user.userRoles">
            <div nz-col>
              <h5 class="wordBreakText">
                <i nz-icon nzType="delete" nzTheme="fill" class="iconVerticalAlign pointerCursor redColor"
                   (click)="showRemoveRoleModal(user.id, role.name)"></i>
                {{role.name}}
              </h5>
              <h6>{{'Claims' | translate}}</h6>
              <div nz-row *ngFor="let roleClaim of role.roleClaims">
                <div nz-col class="wordBreakText">
                  {{roleClaim.claimType}} {{roleClaim.claimValue}}
                </div>
              </div>
              <!--<div nz-row>
                <div nz-col>
                  <button nz-button nzType="primary" nzDanger (click)="showRemoveRoleModal(user.id, role.name)">{{'Delete' | translate}}</button>
                </div>
              </div>-->
              <hr />
            </div>
          </div>
          <div nz-row>
            <div nz-col>
              <button nz-button nzType="primary" (click)="showExistingRolesModal(user.id)">{{'AddRole' | translate}}</button>
            </div>
          </div>
        </div>
      </div>
      <hr />
    </div>
  </div>
  <!--user form-->
  <nz-modal [(nzVisible)]="userFormModalIsVisible" nzTitle="{{'InsertUser' | translate}}" (nzOnCancel)="closeUserFormModal()">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="userForm">
        <nz-form-item>
          <nz-form-control nzErrorTip="{{'ValueCantBeEmpty' | translate}}">
            <nz-input-group>
              <input formControlName="userName" nz-input placeholder="{{'Username' | translate}}" />
            </nz-input-group>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-control nzErrorTip="{{'IncorrectEmailFormat' | translate}}">
            <nz-input-group>
              <input formControlName="email" nz-input placeholder="{{'Email' | translate}}" />
            </nz-input-group>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item *ngIf="!userForm.value.id">
          <nz-form-control nzErrorTip="{{'IncorrectPasswordFormat' | translate}}">
            <nz-input-group>
              <input formControlName="password" nz-input type="password" placeholder="{{'Password' | translate}}" />
            </nz-input-group>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item *ngIf="!userForm.value.id">
          <nz-form-control nzErrorTip="{{'IncorrectConfirmPasswordFormat' | translate}}">
            <nz-input-group>
              <input formControlName="confirmPassword" nz-input type="password" placeholder="{{'ConfirmPassword' | translate}}" />
            </nz-input-group>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item *ngIf="userForm.value.id">
          <nz-form-control nzErrorTip="{{'IncorrectEditPasswordFormat' | translate}}">
            <nz-input-group>
              <input formControlName="editPassword" nz-input type="password" placeholder="{{'Password' | translate}}" />
            </nz-input-group>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item *ngIf="userForm.value.id">
          <nz-form-control nzErrorTip="{{'IncorrectConfirmPasswordFormat' | translate}}">
            <nz-input-group>
              <input formControlName="confirmEditPassword" nz-input type="password" placeholder="{{'ConfirmPassword' | translate}}" />
            </nz-input-group>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-container>
    <div *nzModalFooter>
      <button nz-button nzType="default" (click)="closeUserFormModal()">{{'Cancel' | translate}}</button>
      <button *ngIf="!userForm.value.id" nz-button nzType="primary" (click)="confirmUserFormModal()"
              [disabled]="!userForm.valid || (userForm.value.password != userForm.value.confirmPassword)">
        {{'OK' | translate}}
      </button>
      <button *ngIf="userForm.value.id" nz-button nzType="primary" (click)="confirmUserFormModal()"
              [disabled]="!userForm.valid || (userForm.value.editPassword != userForm.value.confirmEditPassword)">
        {{'OK' | translate}}
      </button>
    </div>
  </nz-modal>
  <!--/user form-->
  <!--delete user-->
  <nz-modal [(nzVisible)]="deleteUserModalIsVisible" nzTitle="{{'DeleteUser' | translate}}" (nzOnCancel)="closeDeleteUserModal()">
    <ng-container *nzModalContent>
      {{'AreYouSure' | translate}}
    </ng-container>
    <div *nzModalFooter>
      <button nz-button nzType="default" (click)="closeDeleteUserModal()">{{'Cancel' | translate}}</button>
      <button nz-button nzType="primary" (click)="confirmDeleteUserModal()">{{'OK' | translate}}</button>
    </div>
  </nz-modal>
  <!--/delete user-->
  <!--add claim-->
  <nz-modal [(nzVisible)]="addCustomUserClaimModalIsVisible" nzTitle="{{'CustomClaim' | translate}}" (nzOnCancel)="closeAddCustomUserClaimModal()">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="addCustomUserClaimForm">
        <nz-form-item>
          <nz-form-control nzErrorTip="{{'ValueCantBeEmpty' | translate}}">
            <nz-input-group>
              <input formControlName="claimType" nz-input placeholder="{{'Type' | translate}}" />
            </nz-input-group>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item>
          <nz-form-control nzErrorTip="{{'ValueCantBeEmpty' | translate}}">
            <nz-input-group>
              <input formControlName="claimValue" nz-input placeholder="{{'Value' | translate}}" />
            </nz-input-group>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-container>
    <div *nzModalFooter>
      <button nz-button nzType="default" (click)="closeAddCustomUserClaimModal()">{{'Cancel' | translate}}</button>
      <button nz-button nzType="primary" (click)="confirmAddCustomUserClaimModal()" [disabled]="!addCustomUserClaimForm.valid">{{'OK' | translate}}</button>
    </div>
  </nz-modal>
  <!--/add claim-->
  <!--remove claim-->
  <nz-modal [(nzVisible)]="removeCustomUserClaimModalIsVisible" nzTitle="{{'RemoveClaim' | translate}}" (nzOnCancel)="closeRemoveCustomUserClaimModal()">
    <ng-container *nzModalContent>
      {{'AreYouSure' | translate}}
    </ng-container>
    <div *nzModalFooter>
      <button nz-button nzType="default" (click)="closeRemoveCustomUserClaimModal()">{{'Cancel' | translate}}</button>
      <button nz-button nzType="primary" (click)="confirmRemoveCustomUserClaimModal()">{{'OK' | translate}}</button>
    </div>
  </nz-modal>
  <!--/remove claim-->
  <!--existing claim-->
  <nz-modal [(nzVisible)]="existingClaimsModalIsVisible" nzTitle="{{'ExistingClaims' | translate}}" (nzOnCancel)="closeExistingClaimsModal()">
    <ng-container *nzModalContent>
      <nz-input-group nzSearch nzAddOnBeforeIcon="search">
        <input type="text" nz-input [(ngModel)]="existingClaimsFilter" placeholder="{{'TypeOrValue' | translate}}" (ngModelChange)="searchExistingClaims()" />
      </nz-input-group>
      <nz-table #existingClaimsTable
                [nzData]="existingClaimsFiltered"
                [nzTableLayout]="'auto'"
                [nzShowPagination]="true"
                [nzShowSizeChanger]="true"
                [nzPageSize]="5"
                [nzPageSizeOptions]="[5,10,20,50]"
                [nzPaginationPosition]="'top'"
                [nzLoading]="pageIsLoading">
        <thead>
          <tr>
            <th *ngFor="let column of existingClaimsColumns"
                [nzSortOrder]="column.sortOrder"
                [nzSortFn]="column.sortFn">
              {{ column.name | translate }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of existingClaimsTable.data">
            <td *ngIf="item.hasClaim"
                class="pointerCursor"
                style="color:green"
                (click)="showRemoveExistingClaimModal(item.claim.claimType, item.claim.claimValue)">
              <div>
                <i class="iconVerticalAlign" nz-icon nzType="check" nzTheme="outline"></i>
              </div>
            </td>
            <td *ngIf="!item.hasClaim"
                class="pointerCursor"
                style="color:red"
                (click)="addExistingClaimToUser(item.claim.claimType, item.claim.claimValue)">
              <div>
                <i class="iconVerticalAlign" nz-icon nzType="close" nzTheme="outline"></i>
              </div>
            </td>
            <td>{{ item.claim.claimType }}</td>
            <td>{{ item.claim.claimValue }}</td>
          </tr>
        </tbody>
      </nz-table>
    </ng-container>
    <div *nzModalFooter>
      <button nz-button nzType="primary" (click)="closeExistingClaimsModal()">{{'Close' | translate}}</button>
    </div>
  </nz-modal>
  <nz-modal [(nzVisible)]="removeExistingClaimModalIsVisible" nzTitle="{{'RemoveClaim' | translate}}" (nzOnCancel)="closeRemoveExistingClaimModal()">
    <ng-container *nzModalContent>
      {{'AreYouSure' | translate}}
    </ng-container>
    <div *nzModalFooter>
      <button nz-button nzType="default" (click)="closeRemoveExistingClaimModal()">{{'Cancel' | translate}}</button>
      <button nz-button nzType="primary" (click)="confirmRemoveExistingClaimModal()">{{'OK' | translate}}</button>
    </div>
  </nz-modal>
  <!--/existing claim-->
  <!--remove role-->
  <nz-modal [(nzVisible)]="removeRoleModalIsVisible" nzTitle="{{'RemoveRole' | translate}}" (nzOnCancel)="closeRemoveRoleModal()">
    <ng-container *nzModalContent>
      {{'AreYouSure' | translate}}
    </ng-container>
    <div *nzModalFooter>
      <button nz-button nzType="default" (click)="closeRemoveRoleModal()">{{'Cancel' | translate}}</button>
      <button nz-button nzType="primary" (click)="confirmRemoveRoleModal()">{{'OK' | translate}}</button>
    </div>
  </nz-modal>
  <!--/remove role-->
  <!--existing role-->
  <nz-modal [(nzVisible)]="existingRolesModalIsVisible" nzTitle="{{'ExistingRoles' | translate}}" (nzOnCancel)="closeExistingRolesModal()">
    <ng-container *nzModalContent>
      <nz-input-group nzSearch nzAddOnBeforeIcon="search">
        <input type="text" nz-input [(ngModel)]="existingRolesFilter" placeholder="{{'TypeOrValue' | translate}}" (ngModelChange)="searchExistingRoles()" />
      </nz-input-group>
      <nz-table #existingRolesTable
                [nzData]="existingRolesFiltered"
                [nzTableLayout]="'auto'"
                [nzShowPagination]="true"
                [nzShowSizeChanger]="true"
                [nzPageSize]="5"
                [nzPageSizeOptions]="[5,10,20,50]"
                [nzPaginationPosition]="'top'"
                [nzLoading]="pageIsLoading">
        <thead>
          <tr>
            <th *ngFor="let column of existingRolesColumns"
                [nzSortOrder]="column.sortOrder"
                [nzSortFn]="column.sortFn">
              {{ column.name | translate }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of existingRolesTable.data">
            <td *ngIf="item.hasRole"
                class="pointerCursor"
                style="color:green"
                (click)="showRemoveExistingRoleModal(item.role.name)">
              <div>
                <i class="iconVerticalAlign" nz-icon nzType="check" nzTheme="outline"></i>
              </div>
            </td>
            <td *ngIf="!item.hasRole"
                class="pointerCursor"
                style="color:red"
                (click)="addExistingRoleToUser(item.role.name)">
              <div>
                <i class="iconVerticalAlign" nz-icon nzType="close" nzTheme="outline"></i>
              </div>
            </td>
            <td>{{ item.role.name }}</td>
          </tr>
        </tbody>
      </nz-table>
    </ng-container>
    <div *nzModalFooter>
      <button nz-button nzType="primary" (click)="closeExistingRolesModal()">{{'Close' | translate}}</button>
    </div>
  </nz-modal>
  <nz-modal [(nzVisible)]="removeExistingRoleModalIsVisible" nzTitle="{{'RemoveRole' | translate}}" (nzOnCancel)="closeRemoveExistingRoleModal()">
    <ng-container *nzModalContent>
      {{'AreYouSure' | translate}}
    </ng-container>
    <div *nzModalFooter>
      <button nz-button nzType="default" (click)="closeRemoveExistingRoleModal()">{{'Cancel' | translate}}</button>
      <button nz-button nzType="primary" (click)="confirmRemoveExistingRoleModal()">{{'OK' | translate}}</button>
    </div>
  </nz-modal>
  <!--/existing role-->
</nz-spin>
